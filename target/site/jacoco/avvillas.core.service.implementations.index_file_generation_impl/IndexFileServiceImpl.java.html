<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IndexFileServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Generaci√≥n de extractos AV Villas</a> &gt; <a href="index.source.html" class="el_package">avvillas.core.service.implementations.index_file_generation_impl</a> &gt; <span class="el_source">IndexFileServiceImpl.java</span></div><h1>IndexFileServiceImpl.java</h1><pre class="source lang-java linenums">package avvillas.core.service.implementations.index_file_generation_impl;

import avvillas.core.constant.MessageConstant;
import avvillas.core.constant.enums.LoadStatus;
import avvillas.core.constant.message.IndexFileMessage;
import avvillas.core.persistence.entity.IndexFileEntity;
import avvillas.core.persistence.mapper.IndexFileMapper;
import avvillas.core.persistence.repository.IndexFileRepository;
import avvillas.core.service.IndexFileService;
import avvillas.core.service.dto.index_file.IndexDto;
import avvillas.core.service.dto.path_index_file.PathExtractsArchiveIndexDto;
import avvillas.core.service.specification.IndexFileSpecification;
import avvillas.core.web.controller.exception.GlobalExceptionHandler;
import avvillas.core.web.traits.LoaderTrait;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;
import org.springframework.stereotype.Service;

import java.util.Objects;
import java.util.Base64;

@Service
<span class="fc" id="L28">@RequiredArgsConstructor</span>
public class IndexFileServiceImpl implements IndexFileService {

    private final IndexFileMapper indexFileMapper;
    private final IndexFileRepository indexFileRepository;
    private final IndexFileAsyncProcessor indexFileAsyncProcessor;

    private final LoaderTrait productTrait;

    @Value(&quot;${MAX_RECORDS_PER_FILE}&quot;)
    private int maxRecordsPerFile;

    @Override
    public IndexDto generateIndexFile(IndexDto indexDto) {
<span class="nc" id="L42">        String productId = indexDto.getProductId();</span>
<span class="nc" id="L43">        String period = indexDto.getPeriod();</span>
<span class="nc" id="L44">        indexFileRepository.findFirstByProductIdAndPeriodAndStatusOrderByCreatedAtDesc(productId, period, LoadStatus.ACTIVO)</span>
<span class="nc" id="L45">                .ifPresent(prev -&gt; {</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">                    if (Objects.equals(prev.getStatus(), LoadStatus.ACTIVO))</span>
<span class="nc" id="L47">                        throw new GlobalExceptionHandler.GlobalMessageException((MessageConstant.format(IndexFileMessage.ERROR_INDEX_FILE_PROCESS, productId)));</span>
<span class="nc" id="L48">                });</span>

<span class="nc" id="L50">        PathExtractsArchiveIndexDto path = productTrait.getIndexFilePathByProductId(productId);</span>


<span class="nc" id="L53">        JwtAuthenticationToken authentication = (JwtAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L54">        String token = authentication.getToken().getTokenValue();</span>

<span class="nc" id="L56">        productTrait.getProductById(productId, token);</span>

<span class="nc" id="L58">        IndexFileEntity indexEntity = indexFileMapper.toEntity(indexDto);</span>
<span class="nc" id="L59">        indexEntity.setRoute(path.getRouteOutputExtract());</span>
<span class="nc" id="L60">        indexEntity.setStatus(LoadStatus.ACTIVO);</span>
<span class="nc" id="L61">        indexEntity.setUser(extractEmailFromToken(token));</span>
<span class="nc" id="L62">        indexEntity.setClientsProcessed(0);</span>
<span class="nc" id="L63">        indexEntity.setPercentAdvance(0);</span>

<span class="nc" id="L65">        IndexFileEntity savedEntity = indexFileRepository.save(indexEntity);</span>

<span class="nc" id="L67">        indexFileAsyncProcessor.processIndexFileAsync(savedEntity.getId(), productId, period, path, maxRecordsPerFile, token);</span>

<span class="nc" id="L69">        return indexFileMapper.toDto(savedEntity);</span>
    }

    public Page&lt;IndexDto&gt; searchGlobal(String search, Pageable pageable) {

<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (search == null || search.trim().isEmpty()) return getAll(pageable);</span>

<span class="nc" id="L76">        Specification&lt;IndexFileEntity&gt; specification = Specification.where(</span>
<span class="nc" id="L77">                        IndexFileSpecification.filterByStatus(search)</span>
<span class="nc" id="L78">                ).or(IndexFileSpecification.filterByProductId(search))</span>
<span class="nc" id="L79">                .or(IndexFileSpecification.filterByPeriod(search))</span>
<span class="nc" id="L80">                .or(IndexFileSpecification.filterByPercentAdvance(search))</span>
<span class="nc" id="L81">                .or(IndexFileSpecification.filterByUser(search));</span>

<span class="nc" id="L83">        return indexFileRepository.findAll(specification, pageable)</span>
<span class="nc" id="L84">                .map(indexFileMapper::toDto);</span>
    }


    private Page&lt;IndexDto&gt; getAll(Pageable pageable) {
<span class="nc" id="L89">        return indexFileRepository.findAll(pageable)</span>
<span class="nc" id="L90">                .map(indexFileMapper::toDto);</span>
    }

    @Override
    public IndexDto getIndexFileByProductIdAndPeriod(String productId, String period) {
<span class="nc" id="L95">        IndexFileEntity indexFileEntity = indexFileRepository</span>
<span class="nc" id="L96">                .findFirstByProductIdAndPeriodAndStatusOrderByCreatedAtDesc(productId, period, LoadStatus.ACTIVO)</span>
<span class="nc" id="L97">                .map(prev -&gt; {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                    if (Objects.equals(prev.getStatus(), LoadStatus.ACTIVO)) {</span>
<span class="nc" id="L99">                        throw new GlobalExceptionHandler.GlobalMessageException(</span>
<span class="nc" id="L100">                                MessageConstant.format(IndexFileMessage.ERROR_INDEX_FILE_PROCESS, productId)</span>
                        );
                    }
<span class="nc" id="L103">                    return prev;</span>
                })
<span class="nc" id="L105">                .orElse(null);</span>

<span class="nc" id="L107">        return indexFileMapper.toDto(indexFileEntity);</span>
    }


    private String extractEmailFromToken(String token) {
<span class="nc" id="L112">        String[] chunks = token.split(&quot;\\.&quot;);</span>
<span class="nc" id="L113">        Base64.Decoder decoder = Base64.getUrlDecoder();</span>
<span class="nc" id="L114">        String payload = new String(decoder.decode(chunks[1]));</span>
<span class="nc" id="L115">        return extractValue(payload);</span>
    }

    private String extractValue(String json) {
        try {
<span class="nc" id="L120">            String searchKey = &quot;\&quot;&quot; + &quot;email&quot; + &quot;\&quot;:\&quot;&quot;;</span>
<span class="nc" id="L121">            int startIndex = json.indexOf(searchKey) + searchKey.length();</span>
<span class="nc" id="L122">            int endIndex = json.indexOf(&quot;\&quot;&quot;, startIndex);</span>
<span class="nc" id="L123">            return json.substring(startIndex, endIndex);</span>
<span class="nc" id="L124">        } catch (Exception e) {</span>
<span class="nc" id="L125">            return &quot;&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>